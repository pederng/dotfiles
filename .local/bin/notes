#! /bin/bash

ndir=${NOTES_DIR-$HOME/.notes}
cmd=$1
COMMANDS=(
  list sync completion
)
shift

function downsync_notes() {
  git --git-dir="$ndir"/.git --work-tree="$ndir" pull
}

function upsync_notes() {
  git --git-dir="$ndir"/.git --work-tree="$ndir"  add .
  git --git-dir="$ndir"/.git --work-tree="$ndir"  commit --author="Autocommiter <>" -m "Autocommit"
  git --git-dir="$ndir"/.git --work-tree="$ndir"  push
}

find_md() {
  find "$ndir" -iname '*.md' | awk -F / '{print $NF}'
}


if [ "$cmd" = "" ]; then
  notes "$(find_md | fzf --preview="cat $ndir/{}")"
else
  case $cmd in
    list)
      find_md
    ;;
    sync)
      downsync_notes
      upsync_notes
    ;;
  completion)
cat << EOF
__notes_completions()
{
    COMPREPLY=( \$(compgen -W "${COMMANDS[*]}" "\${COMP_KEY}") )
}
complete -F __notes_completions notes
EOF
  ;;
    *)
      downsync_notes
      vim "$ndir/$cmd"
      upsync_notes
    ;;
  esac
fi
